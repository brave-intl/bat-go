package payment

import (
	"context"
	"fmt"

	appctx "github.com/brave-intl/bat-go/utils/context"
)

// List of all the allowed and whitelisted brave skus

const (
	prodUserWalletVote              = "AgEJYnJhdmUuY29tAiNicmF2ZSB1c2VyLXdhbGxldC12b3RlIHNrdSB0b2tlbiB2MQACFHNrdT11c2VyLXdhbGxldC12b3RlAAIKcHJpY2U9MC4yNQACDGN1cnJlbmN5PUJBVAACDGRlc2NyaXB0aW9uPQACGmNyZWRlbnRpYWxfdHlwZT1zaW5nbGUtdXNlAAAGIOaNAUCBMKm0IaLqxefhvxOtAKB0OfoiPn0NPVfI602J"
	prodAnonCardVote                = "AgEJYnJhdmUuY29tAiFicmF2ZSBhbm9uLWNhcmQtdm90ZSBza3UgdG9rZW4gdjEAAhJza3U9YW5vbi1jYXJkLXZvdGUAAgpwcmljZT0wLjI1AAIMY3VycmVuY3k9QkFUAAIMZGVzY3JpcHRpb249AAIaY3JlZGVudGlhbF90eXBlPXNpbmdsZS11c2UAAAYgrMZm85YYwnmjPXcegy5pBM5C+ZLfrySZfYiSe13yp8o="
	prodBraveTogetherPaid           = "MDAyMGxvY2F0aW9uIHRvZ2V0aGVyLmJyYXZlLmNvbQowMDMwaWRlbnRpZmllciBicmF2ZS10b2dldGhlci1wYWlkIHNrdSB0b2tlbiB2MQowMDIwY2lkIHNrdT1icmF2ZS10b2dldGhlci1wYWlkCjAwMTBjaWQgcHJpY2U9NQowMDE1Y2lkIGN1cnJlbmN5PVVTRAowMDQzY2lkIGRlc2NyaXB0aW9uPU9uZSBtb250aCBwYWlkIHN1YnNjcmlwdGlvbiBmb3IgQnJhdmUgVG9nZXRoZXIKMDAyNWNpZCBjcmVkZW50aWFsX3R5cGU9dGltZS1saW1pdGVkCjAwMjZjaWQgY3JlZGVudGlhbF92YWxpZF9kdXJhdGlvbj1QMU0KMDAyZnNpZ25hdHVyZSAl/eGfP93lrklACcFClNPvkP3Go0HCtfYVQMs5n/NJpgo="
	prodBraveTalkPremium            = "MDAyMWxvY2F0aW9uIHRhbGstYmV0YS5icmF2ZS5jb20KMDAzNGlkZW50aWZpZXIgYnJhdmUtdGFsay1wcmVtaXVtLXByb2Qgc2t1IHRva2VuIHYxCjAwMjRjaWQgc2t1PWJyYXZlLXRhbGstcHJlbWl1bS1wcm9kCjAwMTNjaWQgcHJpY2U9Ny4wMAowMDE1Y2lkIGN1cnJlbmN5PVVTRAowMDMxY2lkIGRlc2NyaXB0aW9uPVByZW1pdW0gYWNjZXNzIHRvIEJyYXZlIFRhbGsKMDAyM2NpZCBjcmVkZW50aWFsX3R5cGU9c2luZ2xlLXVzZQowMDI3Y2lkIGFsbG93ZWRfcGF5bWVudF9tZXRob2RzPXN0cmlwZQowMTBiY2lkIG1ldGFkYXRhPSB7ICJzdHJpcGVfcHJvZHVjdF9pZCI6ICJwcm9kX0p3NHpReGRIa3B4U09lIiwgInN0cmlwZV9pdGVtX2lkIjogInByaWNlXzFKSUNwRUJTbTFtdHJOOW53Q0t2cFlRNCIsICJzdHJpcGVfc3VjY2Vzc191cmkiOiAiaHR0cHM6Ly9hY2NvdW50LmJyYXZlLmNvbS9hY2NvdW50Lz9pbnRlbnQ9cHJvdmlzaW9uIiwgInN0cmlwZV9jYW5jZWxfdXJpIjogImh0dHBzOi8vYWNjb3VudC5icmF2ZS5jb20vcGxhbnMvP2ludGVudD1jaGVja291dCIgfQowMDJmc2lnbmF0dXJlIEwvmg01yY6JrgX9cYkYb4TUzcROZueKSN5U2hTtq57mCg=="
	prodBraveTalkPremiumTimeLimited = "MDAyMWxvY2F0aW9uIHRhbGstYmV0YS5icmF2ZS5jb20KMDA0MWlkZW50aWZpZXIgYnJhdmUtdGFsay1wcmVtaXVtLXByb2QgdGltZSBsaW1pdGVkIHNrdSB0b2tlbiB2MQowMDI0Y2lkIHNrdT1icmF2ZS10YWxrLXByZW1pdW0tcHJvZAowMDEzY2lkIHByaWNlPTcuMDAKMDAxNWNpZCBjdXJyZW5jeT1VU0QKMDAzMWNpZCBkZXNjcmlwdGlvbj1QcmVtaXVtIGFjY2VzcyB0byBCcmF2ZSBUYWxrCjAwMjVjaWQgY3JlZGVudGlhbF90eXBlPXRpbWUtbGltaXRlZAowMDI2Y2lkIGNyZWRlbnRpYWxfdmFsaWRfZHVyYXRpb249UDFNCjAwMjdjaWQgYWxsb3dlZF9wYXltZW50X21ldGhvZHM9c3RyaXBlCjAxMGJjaWQgbWV0YWRhdGE9IHsgInN0cmlwZV9wcm9kdWN0X2lkIjogInByb2RfSnc0elF4ZEhrcHhTT2UiLCAic3RyaXBlX2l0ZW1faWQiOiAicHJpY2VfMUpJQ3BFQlNtMW10ck45bndDS3ZwWVE0IiwgInN0cmlwZV9zdWNjZXNzX3VyaSI6ICJodHRwczovL2FjY291bnQuYnJhdmUuY29tL2FjY291bnQvP2ludGVudD1wcm92aXNpb24iLCAic3RyaXBlX2NhbmNlbF91cmkiOiAiaHR0cHM6Ly9hY2NvdW50LmJyYXZlLmNvbS9wbGFucy8/aW50ZW50PWNoZWNrb3V0IiB9CjAwMmZzaWduYXR1cmUg3H9TLV2HJDQXk2h0GrSqEluNtkPAewTp9nu+p+PUlCcK"

	stagingUserWalletVote   = "AgEJYnJhdmUuY29tAiNicmF2ZSB1c2VyLXdhbGxldC12b3RlIHNrdSB0b2tlbiB2MQACFHNrdT11c2VyLXdhbGxldC12b3RlAAIKcHJpY2U9MC4yNQACDGN1cnJlbmN5PUJBVAACDGRlc2NyaXB0aW9uPQACGmNyZWRlbnRpYWxfdHlwZT1zaW5nbGUtdXNlAAAGIOH4Li+rduCtFOfV8Lfa2o8h4SQjN5CuIwxmeQFjOk4W"
	stagingAnonCardVote     = "AgEJYnJhdmUuY29tAiFicmF2ZSBhbm9uLWNhcmQtdm90ZSBza3UgdG9rZW4gdjEAAhJza3U9YW5vbi1jYXJkLXZvdGUAAgpwcmljZT0wLjI1AAIMY3VycmVuY3k9QkFUAAIMZGVzY3JpcHRpb249AAIaY3JlZGVudGlhbF90eXBlPXNpbmdsZS11c2UAAAYgPV/WYY5pXhodMPvsilnrLzNH6MA8nFXwyg0qSWX477M="
	stagingWebtestPJSKUDemo = "AgEYd2VidGVzdC1wai5oZXJva3VhcHAuY29tAih3ZWJ0ZXN0LXBqLmhlcm9rdWFwcC5jb20gYnJhdmUtdHNoaXJ0IHYxAAIQc2t1PWJyYXZlLXRzaGlydAACCnByaWNlPTAuMjUAAgxjdXJyZW5jeT1CQVQAAgxkZXNjcmlwdGlvbj0AAhpjcmVkZW50aWFsX3R5cGU9c2luZ2xlLXVzZQAABiCcJ0zXGbSg+s3vsClkci44QQQTzWJb9UPyJASMVU11jw=="

	stagingBraveTalkPremium = "MDAyOWxvY2F0aW9uIHRhbGstYmV0YS5icmF2ZXNvZnR3YXJlLmNvbQowMDJmaWRlbnRpZmllciBicmF2ZS10YWxrLXByZW1pdW0gc2t1IHRva2VuIHYxCjAwMWZjaWQgc2t1PWJyYXZlLXRhbGstcHJlbWl1bQowMDEzY2lkIHByaWNlPTcuMDAKMDAxNWNpZCBjdXJyZW5jeT1VU0QKMDAzMWNpZCBkZXNjcmlwdGlvbj1QcmVtaXVtIGFjY2VzcyB0byBCcmF2ZSBUYWxrCjAwMjNjaWQgY3JlZGVudGlhbF90eXBlPXNpbmdsZS11c2UKMDAyN2NpZCBhbGxvd2VkX3BheW1lbnRfbWV0aG9kcz1zdHJpcGUKMDExYmNpZCBtZXRhZGF0YT0geyAic3RyaXBlX3Byb2R1Y3RfaWQiOiAicHJvZF9KbGMyMjRoRnZBTXZFcCIsICJzdHJpcGVfaXRlbV9pZCI6ICJwcmljZV8xSjg0b01Ib2YyMGJwaEc2TkJBVDJ2b3IiLCAic3RyaXBlX3N1Y2Nlc3NfdXJpIjogImh0dHBzOi8vYWNjb3VudC5icmF2ZXNvZnR3YXJlLmNvbS9hY2NvdW50Lz9pbnRlbnQ9cHJvdmlzaW9uIiwgInN0cmlwZV9jYW5jZWxfdXJpIjogImh0dHBzOi8vYWNjb3VudC5icmF2ZXNvZnR3YXJlLmNvbS9wbGFucy8/aW50ZW50PWNoZWNrb3V0IiB9CjAwMmZzaWduYXR1cmUgy/IBsIF5eROon9zZ7oxG0zIgOE98X/Lpk8yvn9X0MP0K"

	stagingBraveTalkPremiumTimeLimited = "MDAyOWxvY2F0aW9uIHRhbGstYmV0YS5icmF2ZXNvZnR3YXJlLmNvbQowMDJmaWRlbnRpZmllciBicmF2ZS10YWxrLXByZW1pdW0gc2t1IHRva2VuIHYxCjAwMWZjaWQgc2t1PWJyYXZlLXRhbGstcHJlbWl1bQowMDEzY2lkIHByaWNlPTcuMDAKMDAxNWNpZCBjdXJyZW5jeT1VU0QKMDAzMWNpZCBkZXNjcmlwdGlvbj1QcmVtaXVtIGFjY2VzcyB0byBCcmF2ZSBUYWxrCjAwMjVjaWQgY3JlZGVudGlhbF90eXBlPXRpbWUtbGltaXRlZAowMDI2Y2lkIGNyZWRlbnRpYWxfdmFsaWRfZHVyYXRpb249UDFNCjAwMjdjaWQgYWxsb3dlZF9wYXltZW50X21ldGhvZHM9c3RyaXBlCjAxMWJjaWQgbWV0YWRhdGE9IHsgInN0cmlwZV9wcm9kdWN0X2lkIjogInByb2RfSmxjMjI0aEZ2QU12RXAiLCAic3RyaXBlX2l0ZW1faWQiOiAicHJpY2VfMUo4NG9NSG9mMjBicGhHNk5CQVQydm9yIiwgInN0cmlwZV9zdWNjZXNzX3VyaSI6ICJodHRwczovL2FjY291bnQuYnJhdmVzb2Z0d2FyZS5jb20vYWNjb3VudC8/aW50ZW50PXByb3Zpc2lvbiIsICJzdHJpcGVfY2FuY2VsX3VyaSI6ICJodHRwczovL2FjY291bnQuYnJhdmVzb2Z0d2FyZS5jb20vcGxhbnMvP2ludGVudD1jaGVja291dCIgfQowMDJmc2lnbmF0dXJlIMK5WE3JZvhd8xl+jx8eMn1dkDqtiGAd9JuyMz7q66zKCg=="

	devUserWalletVote   = "AgEJYnJhdmUuY29tAiNicmF2ZSB1c2VyLXdhbGxldC12b3RlIHNrdSB0b2tlbiB2MQACFHNrdT11c2VyLXdhbGxldC12b3RlAAIKcHJpY2U9MC4yNQACDGN1cnJlbmN5PUJBVAACDGRlc2NyaXB0aW9uPQACGmNyZWRlbnRpYWxfdHlwZT1zaW5nbGUtdXNlAAAGINiB9dUmpqLyeSEdZ23E4dPXwIBOUNJCFN9d5toIME2M"
	devAnonCardVote     = "AgEJYnJhdmUuY29tAiFicmF2ZSBhbm9uLWNhcmQtdm90ZSBza3UgdG9rZW4gdjEAAhJza3U9YW5vbi1jYXJkLXZvdGUAAgpwcmljZT0wLjI1AAIMY3VycmVuY3k9QkFUAAIMZGVzY3JpcHRpb249AAIaY3JlZGVudGlhbF90eXBlPXNpbmdsZS11c2UAAAYgPpv+Al9jRgVCaR49/AoRrsjQqXGqkwaNfqVka00SJxQ="
	devSearchClosedBeta = "AgEVc2VhcmNoLmJyYXZlLnNvZnR3YXJlAh9zZWFyY2ggY2xvc2VkIGJldGEgcHJvZ3JhbSBkZW1vAAIWc2t1PXNlYXJjaC1iZXRhLWFjY2VzcwACB3ByaWNlPTAAAgxjdXJyZW5jeT1CQVQAAi1kZXNjcmlwdGlvbj1TZWFyY2ggY2xvc2VkIGJldGEgcHJvZ3JhbSBhY2Nlc3MAAhpjcmVkZW50aWFsX3R5cGU9c2luZ2xlLXVzZQAABiB3uXfAAkNSRQd24jSauRny3VM0BYZ8yOclPTEgPa0xrA=="

	devBraveTalkPremium = "MDAyNmxvY2F0aW9uIHRhbGstYmV0YS5icmF2ZS5zb2Z0d2FyZQowMDJmaWRlbnRpZmllciBicmF2ZS10YWxrLXByZW1pdW0gc2t1IHRva2VuIHYxCjAwMWZjaWQgc2t1PWJyYXZlLXRhbGstcHJlbWl1bQowMDEzY2lkIHByaWNlPTcuMDAKMDAxNWNpZCBjdXJyZW5jeT1VU0QKMDAzMWNpZCBkZXNjcmlwdGlvbj1QcmVtaXVtIGFjY2VzcyB0byBCcmF2ZSBUYWxrCjAwMjNjaWQgY3JlZGVudGlhbF90eXBlPXNpbmdsZS11c2UKMDAyN2NpZCBhbGxvd2VkX3BheW1lbnRfbWV0aG9kcz1zdHJpcGUKMDExNWNpZCBtZXRhZGF0YT0geyAic3RyaXBlX3Byb2R1Y3RfaWQiOiAicHJvZF9KbGMyMjRoRnZBTXZFcCIsICJzdHJpcGVfaXRlbV9pZCI6ICJwcmljZV8xSjg0b01Ib2YyMGJwaEc2TkJBVDJ2b3IiLCAic3RyaXBlX3N1Y2Nlc3NfdXJpIjogImh0dHBzOi8vYWNjb3VudC5icmF2ZS5zb2Z0d2FyZS9hY2NvdW50Lz9pbnRlbnQ9cHJvdmlzaW9uIiwgInN0cmlwZV9jYW5jZWxfdXJpIjogImh0dHBzOi8vYWNjb3VudC5icmF2ZS5zb2Z0d2FyZS9wbGFucy8/aW50ZW50PWNoZWNrb3V0IiB9CjAwMmZzaWduYXR1cmUgiwlphDok6a8SFEDPuFx9OGs2iOj/fwIUq4THeOcVuCgK"

	devBraveTalkPremiumTimeLimited = "MDAyNmxvY2F0aW9uIHRhbGstYmV0YS5icmF2ZS5zb2Z0d2FyZQowMDJmaWRlbnRpZmllciBicmF2ZS10YWxrLXByZW1pdW0gc2t1IHRva2VuIHYxCjAwMWZjaWQgc2t1PWJyYXZlLXRhbGstcHJlbWl1bQowMDEzY2lkIHByaWNlPTcuMDAKMDAxNWNpZCBjdXJyZW5jeT1VU0QKMDAzMWNpZCBkZXNjcmlwdGlvbj1QcmVtaXVtIGFjY2VzcyB0byBCcmF2ZSBUYWxrCjAwMjVjaWQgY3JlZGVudGlhbF90eXBlPXRpbWUtbGltaXRlZAowMDI2Y2lkIGNyZWRlbnRpYWxfdmFsaWRfZHVyYXRpb249UDFNCjAwMjdjaWQgYWxsb3dlZF9wYXltZW50X21ldGhvZHM9c3RyaXBlCjAxMTVjaWQgbWV0YWRhdGE9IHsgInN0cmlwZV9wcm9kdWN0X2lkIjogInByb2RfSmxjMjI0aEZ2QU12RXAiLCAic3RyaXBlX2l0ZW1faWQiOiAicHJpY2VfMUo4NG9NSG9mMjBicGhHNk5CQVQydm9yIiwgInN0cmlwZV9zdWNjZXNzX3VyaSI6ICJodHRwczovL2FjY291bnQuYnJhdmUuc29mdHdhcmUvYWNjb3VudC8/aW50ZW50PXByb3Zpc2lvbiIsICJzdHJpcGVfY2FuY2VsX3VyaSI6ICJodHRwczovL2FjY291bnQuYnJhdmUuc29mdHdhcmUvcGxhbnMvP2ludGVudD1jaGVja291dCIgfQowMDJmc2lnbmF0dXJlIKK9UFEoa/nfuBDtSlCRyyqryaezzRFMNs5weCJ5129uCg=="
)

var skuMap = map[string]map[string]bool{
	"production": {
		prodUserWalletVote:              true,
		prodAnonCardVote:                true,
		prodBraveTogetherPaid:           true,
		prodBraveTalkPremium:            true,
		prodBraveTalkPremiumTimeLimited: true,
	},
	"staging": {
		stagingUserWalletVote:              true,
		stagingAnonCardVote:                true,
		stagingWebtestPJSKUDemo:            true,
		stagingBraveTalkPremium:            true,
		stagingBraveTalkPremiumTimeLimited: true,
	},
	"development": {
		devUserWalletVote:              true,
		devAnonCardVote:                true,
		devSearchClosedBeta:            true,
		devBraveTalkPremium:            true,
		devBraveTalkPremiumTimeLimited: true,
	},
}

// temporary, until we can validate macaroon signatures
func validateHardcodedSku(ctx context.Context, sku string) (bool, error) {
	// check sku white list from environment
	whitelistSKUs, ok := ctx.Value(appctx.WhitelistSKUsCTXKey).([]string)
	if ok {
		for _, whitelistSKU := range whitelistSKUs {
			if sku == whitelistSKU {
				return true, nil
			}
		}
	}

	// check hardcoded based on environment (non whitelisted)
	env, err := appctx.GetStringFromContext(ctx, appctx.EnvironmentCTXKey)
	if err != nil {
		return false, fmt.Errorf("failed to get environment: %w", err)
	}
	valid, ok := skuMap[env][sku]
	return valid && ok, nil
}
